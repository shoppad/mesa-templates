{
    "key": "shopify/order/email_specific_discount_notification",
    "name": "Send an Email When a Specific Discount is Used",
    "version": "1.0.0",
    "enabled": false,
    "setup": true,
    "config": {
        "inputs": [
            {
                "schema": 3,
                "trigger_type": "input",
                "type": "shopify",
                "entity": "order",
                "action": "created",
                "name": "Order Created",
                "key": "shopify",
                "operation_id": "orders_create",
                "metadata": {
                    "frequency": "every",
                    "includeFields": []
                },
                "local_fields": [],
                "selected_fields": [],
                "on_error": "default",
                "weight": 0
            }
        ],
        "outputs": [
            {
                "schema": 3.1,
                "trigger_type": "output",
                "type": "shopify",
                "entity": "shop",
                "action": "list",
                "name": "Retrieve Shop",
                "key": "shopify_1",
                "operation_id": "get_shop",
                "metadata": {
                    "api_endpoint": "get admin/shop.json"
                },
                "local_fields": [],
                "selected_fields": [],
                "on_error": "default",
                "weight": 0
            },
            {
                "schema": 5.1,
                "trigger_type": "output",
                "type": "loop",
                "entity": "loop",
                "name": "Discount Codes",
                "version": "v3",
                "key": "loop",
                "operation_id": "loop_loop",
                "metadata": {
                    "key": "{{shopify.discount_codes[]}}",
                    "filter": {
                        "a": "{{shopify.discount_codes[].code}}",
                        "comparison": "equals",
                        "b": "{{ template | label: 'Which discount code should MESA watch for?', description: 'Enter the exact promo code you want MESA to detect when a customer uses it at checkout.', tokens: false }}",
                        "additional": [
                            {
                                "operator": "and",
                                "comparison": "equals"
                            }
                        ]
                    }
                },
                "local_fields": [],
                "selected_fields": [],
                "on_error": "default",
                "weight": 1
            },
            {
                "schema": 5,
                "trigger_type": "output",
                "type": "email",
                "name": "Send Email",
                "version": "v2",
                "key": "email",
                "operation_id": "/send-email",
                "metadata": {
                    "api_endpoint": "post /send-email",
                    "trigger_parent_key": "loop",
                    "body": {
                        "to": "{{ template | label: 'What email address should receive the alert?', description: 'Provide the email where MESA should send the notification whenever this discount code is used.', tokens: false }}",
                        "subject": "Discount {{loop.code}} has just been applied to Shopify order {{shopify.name}}",
                        "message": "<p>Heads up \u2013 the discount code {{loop.code}} was just used on your store.</p><p><strong>Order summary</strong></p><ul><li><p>Order number: {{shopify.name}}</p></li><li><p>Order date: {{ shopify.created_at | date: \"%B %e, %Y\" }}</p></li><li><p>Customer: {{shopify.billing_address.name}}, {{shopify.email}}</p></li></ul><p><strong>Discount details</strong></p><ul><li><p>Code used: {{loop.code}}</p></li><li><p>Discount type: {{loop.type}}</p></li><li><p>Discount amount: {{loop.amount}}</p></li></ul><p><strong>Items in this order</strong><br>{% for line_item in shopify.line_items %}</p><ul><li><p>{{ line_item.quantity }} \u00d7 {{ line_item.title }} \u2013 {{ line_item.line_price }}<br>{% endfor %}</p></li></ul><p><strong>Payment &amp; totals</strong></p><ul><li><p>Subtotal: {{shopify.current_subtotal_price}}</p></li><li><p>Discount: {{shopify.current_total_discounts}}</p></li><li><p>Shipping: {{shopify.shipping_lines[0].price}}</p></li><li><p>Taxes: {{shopify.total_tax}}</p></li><li><p><strong>Total paid:</strong> {{shopify.current_total_price}}</p></li></ul><p><strong>Quick links</strong></p><ul><li><p>View order in Shopify: <a target=\"_blank\" rel=\"noopener noreferrer nofollow\" class=\"text-blue-600 underline\" href=\"https://admin.shopify.com/store/{{shopify_1.myshopify_domain | replace: \".myshopify.com\", \"\"}}/orders/{{shopify.id}}\">https://admin.shopify.com/store/{{shopify_1.myshopify_domain | replace: \".myshopify.com\", \"\"}}/orders/{{shopify.id}}</a></p></li><li><p>View customer profile: <a target=\"_blank\" rel=\"noopener noreferrer nofollow\" class=\"text-blue-600 underline\" href=\"https://admin.shopify.com/store/{{shopify_1.myshopify_domain | replace: \".myshopify.com\", \"\"}}/customers/{{shopify.customer.id}}\">https://admin.shopify.com/store/{{shopify_1.myshopify_domain | replace: \".myshopify.com\", \"\"}}/customers/{{shopify.customer.id}}</a></p></li></ul><p></p><p></p>"
                    }
                },
                "local_fields": [],
                "selected_fields": [],
                "on_error": "default",
                "weight": 2
            },
            {
                "schema": 5.1,
                "trigger_type": "output",
                "type": "loop",
                "entity": "end",
                "name": "Loop End",
                "version": "v3",
                "key": "loop_1",
                "operation_id": "loop_end",
                "metadata": {
                    "trigger_manager_key": "loop",
                    "trigger_parent_key": "loop"
                },
                "local_fields": [],
                "selected_fields": [],
                "on_error": "default",
                "weight": 3
            }
        ]
    }
}
